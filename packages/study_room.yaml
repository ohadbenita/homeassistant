---
automation:
  - alias: "Study Room - Turn AC and lights off when no one is in the room"
    id: study_room_turn_ac_and_lights_off
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.apollo_msr_1_ce7700_radar_target
        to: 'off'
        for:
          minutes: 10

    condition:
      condition: template
      value_template: >-
        {{ not is_state('climate.study_room_ac', 'off') }}

    action:
      - action: switch.turn_on
        entity_id: switch.study_room_ac_beeper

      - action: climate.turn_off
        data_template:
          entity_id: climate.study_room_ac

      - action: switch.turn_off
        entity_id: switch.study_room_ac_beeper

      - action: homeassistant.turn_off
        data_template:
          entity_id: switch.shellyplus1pm_e465b8f12024_switch_0


  - alias: "Study Room - Turn lights on immediately, AC after 5 minutes"
    initial_state: true
    id: study_room_turn_lights_on_ac_delay
    trigger:
      - platform: state
        entity_id: binary_sensor.apollo_msr_1_ce7700_radar_target
        to: 'on'

    action:
      # Turn on the lights immediately
      - action: homeassistant.turn_on
        entity_id: switch.shellyplus1pm_e465b8f12024_switch_0

      - wait_for_trigger:
          - platform: state
            entity_id: binary_sensor.apollo_msr_1_ce7700_radar_target
            to: 'on'
            for: "00:05:00"
        continue_on_timeout: false

      - action: switch.turn_on
        entity_id: switch.study_room_ac_beeper

      - action: climate.set_hvac_mode
        target:
          entity_id: climate.study_room_ac
        data:
          hvac_mode: cool

      - action: switch.turn_off
        entity_id: switch.study_room_ac_beeper

      - action: climate.set_preset_mode
        data:
          preset_mode: sleep
          entity_id: climate.study_room_ac

      - action: climate.set_temperature
        data:
          temperature: 24
          entity_id: climate.study_room_ac

      - action: climate.set_fan_mode
        data:
          fan_mode: silent
          entity_id: climate.study_room_ac

      - action: climate.set_swing_mode
        data:
          swing_mode: both
          entity_id: climate.study_room_ac


  - alias: "Study Room - Close cover on sunset"
    initial_state: true
    id: study_room_close_cover_sunset
    trigger:
      - platform: sun
        event: sunset
        offset: "-03:00:00"

    condition:
      - condition: state
        entity_id: input_boolean.away_mode
        state: 'off'

    action:
      - action: cover.close_cover
        entity_id: cover.study_room


  - alias: "Study Room - Open cover in the morning"
    initial_state: true
    id: study_room_open_cover_morning
    trigger:
      - platform: time
        at: "08:00:00"

    condition:
      - condition: state
        entity_id: input_boolean.away_mode
        state: 'off'

    action:
      - action: cover.set_cover_position
        data_template:
          entity_id: cover.study_room
          position: >-
            {{ max(state_attr('cover.study_room', 'current_position') | int, 80) }}


  - alias: "Study Room - Toggle light by switch"
    initial_state: true
    id: study_room_toggle_light_by_switch
    trigger:
      - platform: state
        entity_id: sensor.study_room_01_action
        to: 'open'

    action:
      - action: switch.toggle
        entity_id: switch.shellyplus1pm_e465b8f12024_switch_0


  - alias: "Study Room - Toggle AC by switch"
    initial_state: true
    id: study_room_toggle_ac_by_switch
    trigger:
      - platform: state
        entity_id: sensor.study_room_01_action
        to: 'close'

    action:
      - action: climate.toggle
        entity_id: climate.study_room_ac
